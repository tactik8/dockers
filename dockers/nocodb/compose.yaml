version: '3.8'

services:
  nocodb:
    image: nocodb/nocodb:latest
    # NocoDB requires a database to connect to. We'll use PostgreSQL here.
    # Make sure to replace <NocoDB_Port> with your desired port.
    ports:
      - "8080:8080" # Default NocoDB port, change if needed
    environment:
      # Database connection string for NocoDB to connect to PostgreSQL
      # Replace POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB with your actual values
      NC_DB: 'pg://postgres_user:postgres_password@postgres:5432/nocodb_db'
      # Set timezone to Eastern (Canada)
      TZ: 'America/Toronto'
      # Set language to en-us
      LANG: 'en_US.UTF-8'
    volumes:
      # Persistent storage for NocoDB data
      - /mnt/nas4/dockers/nocodb/data:/usr/app/data
    depends_on:
      - postgres
    networks:
      - nocodb-net
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.nocodb == true # Adjust node label as per your swarm setup
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  postgres:
    image: postgres:13
    environment:
      # PostgreSQL database configuration
      # !!! IMPORTANT !!! Replace with strong, unique passwords
      POSTGRES_DB: 'nocodb_db'
      POSTGRES_USER: 'postgres_user'
      POSTGRES_PASSWORD: 'postgres_password'
      # Set timezone for PostgreSQL
      TZ: 'America/Toronto'
    volumes:
      # Persistent storage for PostgreSQL data
      - /mnt/nas4/dockers/nocodb/postgres:/var/lib/postgresql/data
    networks:
      - nocodb-net
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.nocodb == true # Adjust node label as per your swarm setup
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

networks:
  nocodb-net:
    driver: overlay
    attachable: true
